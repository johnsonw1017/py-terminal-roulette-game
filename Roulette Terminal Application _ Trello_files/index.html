
<!-- saved from url=(0039)https://www.figma.com/trello/index.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252"><script src="./power-up.min.js"></script>
<script src="./shared.js"></script>
<script src="./search.js"></script>
<script>

var getKey = function(t, key) {
  return t.get('organization', 'private', key, null)
  .then(function(token) {
    if (token != null) return token;
    return t.get('board', 'private', key, null);
  });
};

var nullCallback = function(t, options) {
  t.closePopup();
}

var figmaMenu = function (t, options) {
  return getKey(t, 'token')
  .then(function (token) {
    if (token == null) {
      return t.popup({
        title: 'Figma',
        url: './auth',
        height: 80
      });
    } else {
      return showMenu(token, t, options);
    }
  });
};

window.TrelloPowerUp.initialize({
  'attachment-sections': function(t, options) {
    var claimed = options.entries.filter(function(attachment) {
      return attachment.url.match(URL_REGEX);
    });

    if (claimed && claimed.length > 0) {
      return [{
        claimed,
        icon: GRAY_ICON,
        title: "Figma files",
        content: {
          type: 'iframe',
          url: t.signUrl("./iframe"),
          height: 10
        }
      }];
    }
  },
  'card-buttons': function(t, options) {
    return getKey(t, 'token')
    .then(function(token) {
      if (token == null) return null;
      return makeReq('GET', '/api/oauth/validate', token)
      .then(function() {
        return token;
      }).catch(function () {
        return t.remove('organization', 'private', 'token')
        .catch(t.NotHandled, function() {
          return t.remove('board', 'private', 'token');
        });
      });
    })
    .then(function() {
      return [{
        icon: GRAY_ICON,
        text: 'Figma',
        callback: figmaMenu
      }];
    });
  },
  'format-url': function(t, options) {
    var matched = options.url.match(URL_REGEX);
    if (matched == null) throw t.NotHandled();

    return getKey(t, 'token')
    .then(function(token) {
      return makeReq('GET', '/api/oauth/validate', token)
      .then(function(resp) {
        var name = resp.meta.name;
        if (matched[2] === 'proto') {
          name += ' (prototype)';
        }

        return {
          icon: GRAY_ICON,
          text: name,
        };
      })
      .catch(function() {
        var splitUrl = options.url.split('/');
        var slug = splitUrl[splitUrl.length - 1].split('?')[0];
        if (matched[2] === 'proto') {
          slug += ' (prototype)';
        }

        return {
          icon: GRAY_ICON,
          text: decodeURI(slug),
        };
      });
    });
  }
});

</script>
</head><body>
</body></html>